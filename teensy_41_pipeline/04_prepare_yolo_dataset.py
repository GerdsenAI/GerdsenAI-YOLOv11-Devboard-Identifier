#!/usr/bin/env python3
"""
04_prepare_yolo_dataset.py - Prepare Teensy 4.1 YOLO Dataset

Creates YOLO-format dataset with train/val/test splits.
Single class: teensy_41 (class_id = 0)

Usage:
    python 04_prepare_yolo_dataset.py
    python 04_prepare_yolo_dataset.py --split 0.7 0.2 0.1
"""

import os
import sys
import random
import shutil
from pathlib import Path
import logging

logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

INPUT_DIR = Path(__file__).parent / 'data' / 'augmented'
OUTPUT_DIR = Path(__file__).parent / 'data' / 'yolo'


def create_approximate_label(image_path: Path, class_id: int = 0) -> str:
    """
    Create approximate bounding box label.
    For single-board images, assume board is centered and covers ~80% of image.
    Format: class_id x_center y_center width height (normalized 0-1)
    """
    # Approximate: board is centered, covers 80% width, 70% height
    x_center = 0.5
    y_center = 0.5
    width = 0.8
    height = 0.7

    return f"{class_id} {x_center} {y_center} {width} {height}"


def main():
    import argparse
    parser = argparse.ArgumentParser(description='Prepare Teensy 4.1 YOLO dataset')
    parser.add_argument('--input', type=str, default=None, help='Input directory')
    parser.add_argument('--output', type=str, default=None, help='Output directory')
    parser.add_argument('--split', nargs=3, type=float, default=[0.7, 0.2, 0.1],
                        help='Train/val/test split ratios')
    args = parser.parse_args()

    input_dir = Path(args.input) if args.input else INPUT_DIR
    output_dir = Path(args.output) if args.output else OUTPUT_DIR

    train_ratio, val_ratio, test_ratio = args.split
    assert abs(sum(args.split) - 1.0) < 0.01, "Split ratios must sum to 1"

    # Create directory structure
    for split in ['train', 'val', 'test']:
        (output_dir / split / 'images').mkdir(parents=True, exist_ok=True)
        (output_dir / split / 'labels').mkdir(parents=True, exist_ok=True)

    # Get all images
    images = list(input_dir.glob('*.jpg')) + list(input_dir.glob('*.jpeg')) + list(input_dir.glob('*.png'))
    random.shuffle(images)

    if not images:
        logger.error(f"No images found in {input_dir}")
        sys.exit(1)

    logger.info(f"Found {len(images)} images")

    # Calculate split sizes
    n_train = int(len(images) * train_ratio)
    n_val = int(len(images) * val_ratio)

    train_images = images[:n_train]
    val_images = images[n_train:n_train + n_val]
    test_images = images[n_train + n_val:]

    splits = [
        ('train', train_images),
        ('val', val_images),
        ('test', test_images),
    ]

    # Process each split
    for split_name, split_images in splits:
        for img_path in split_images:
            # Copy image
            dest_img = output_dir / split_name / 'images' / img_path.name
            shutil.copy2(img_path, dest_img)

            # Create label file
            label_content = create_approximate_label(img_path, class_id=0)
            label_path = output_dir / split_name / 'labels' / (img_path.stem + '.txt')
            with open(label_path, 'w') as f:
                f.write(label_content + '\n')

        logger.info(f"  {split_name}: {len(split_images)} images")

    # Create data.yaml
    data_yaml = f"""# Teensy 4.1 YOLOv11 Dataset
# Auto-generated by 04_prepare_yolo_dataset.py

path: {output_dir.absolute()}
train: train/images
val: val/images
test: test/images

# Single class
nc: 1
names:
  0: teensy_41
"""

    yaml_path = output_dir / 'data.yaml'
    with open(yaml_path, 'w') as f:
        f.write(data_yaml)

    logger.info(f"\nCreated data.yaml: {yaml_path}")

    print("\n" + "=" * 50)
    print("YOLO DATASET PREPARED")
    print("=" * 50)
    print(f"Class: teensy_41")
    print(f"  Train: {len(train_images)} images")
    print(f"  Val:   {len(val_images)} images")
    print(f"  Test:  {len(test_images)} images")
    print(f"\nOutput: {output_dir}")
    print(f"Config: {yaml_path}")
    print("=" * 50)
    print("\nNOTE: Labels use approximate bounding boxes.")
    print("For production, annotate with Roboflow or LabelImg.")
    print("\nNext: python 05_train_model.py")


if __name__ == '__main__':
    main()
